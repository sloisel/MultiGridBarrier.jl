using MultiGridBarrier
using Test
using LinearAlgebra

Base.show(x, ::MIME{Symbol("text/html")}, ::String) = nothing

@testset "MultiGridBarrier.jl" begin
    z = reshape(Float64[-1,-1,-1,1,0,0,2,2],(:,2))
    SOL = fem1d_solve(L=1,p=1.0);
    @test norm(SOL.z-z)<1e-6
    @test abs(interpolate(SOL.geometry,SOL.z[:,1],0.75)-0.5)<1e-6
    @test (plot(SOL); true)
    z = reshape([2.0,1.0,2.0,1.0,2.0,1.0,0.9629629615502254,2.0,1.0,2.0,1.0,2.0,1.0,0.9629629615502254,2.8284271303696036,0.0,2.0,0.0,2.0,0.0,0.0,2.0,0.0,2.8284271303696036,0.0,2.0,0.0,0.0],(:,2))
    sol = fem2d_solve(L=1,p=1.0)
    @test norm(sol.z - z) < 1e-6
    @test (plot(sol); true)
    z = reshape([-1.0,-0.9937184291481691,-1.0606601198186663,-0.28661158923558694,1.0,5.3340857286533046e-8,6.270131188059596e-8,1.0297480733710706e-7,2.999999898325467,5.999999681130596],(:,2))
    sol = spectral1d_solve(n=5,p=1.0)
    @test norm(sol.z - z) < 1e-6
    @test (plot(sol); true)
    z = reshape([2.0,1.5,1.0,1.5,2.0,1.5,1.3293564567737008,1.000000018263945,1.3293564567737008,1.5,1.0,1.000000018263945,0.9999999999999992,1.000000018263945,1.0,1.5,1.3293564567737008,1.000000018263945,1.3293564567737006,1.5,2.0,1.5,1.0,1.5,2.0,2.8284271380814046,1.4605935026827006,1.6292452074881896e-7,1.460593502682701,2.8284271380814046,1.4605935026827004,0.9999999768073243,5.33408572865331e-8,0.9999999768073249,1.4605935026827008,1.6292452092368193e-7,5.33408572865331e-8,5.3340857286533106e-8,5.33408572865331e-8,1.6292452052399464e-7,1.4605935026827006,0.9999999768073246,5.334085728653312e-8,0.9999999768073247,1.460593502682701,2.8284271380814046,1.4605935026827008,1.6292452069885802e-7,1.4605935026827015,2.8284271380814046],(:,2))
    sol = spectral2d_solve(n=5,p=1.0)
    @test norm(sol.z - z) < 1e-6
    @test (plot(sol); true)
    z = [-1.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 0.0; 1.0 0.0 0.0;;; -1.0 1.0000000112468264 0.7500000142459804; -0.24999999700084627 0.06250000974724965 0.7500000142459804; -0.24999999700084627 0.06250000974724965 1.2500000082476728; 1.0 1.0000000112468264 1.2500000082476728;;; -1.0 1.00000002 0.5000000363324867; -0.4999999836675137 0.2500000036675139 0.5000000363324867; -0.4999999836675137 0.2500000036675139 1.5000000036675138; 1.0 1.00000002 1.5000000036675138]
    sol = parabolic_solve(fem1d(;L=1); h=0.5, p=1.0)
    @test norm(cat(sol.u...; dims=3) - z) < 1e-6
    @test (plot(sol); true)
    z = [2.0 0.0 0.0; 1.0 0.0 0.0; 2.0 0.0 0.0; 0.0 0.0 0.0; 2.0 0.0 0.0; 1.0 0.0 0.0; 0.2222222222222222 0.0 0.0; 2.0 0.0 0.0; 1.0 0.0 0.0; 2.0 0.0 0.0; 1.0 0.0 0.0; 2.0 0.0 0.0; 0.0 0.0 0.0; 0.2222222222222222 0.0 0.0;;; 2.0 4.00000002 2.82842714474619; 1.0 1.0000000199999999 0.0754518357307923; 2.0 4.00000002 2.0014227581346167; 0.9622740913884575 0.9259714469574816 4.011103905995438e-8; 2.0 4.00000002 2.0014227581346167; 1.0 1.0000000199999999 0.0754518357307923; 0.9350178459150931 0.8742583921797008 0.03556834774086649; 2.0 4.00000002 2.0014227581346167; 1.0 1.0000000199999999 0.0754518357307923; 2.0 4.00000002 2.82842714474619; 1.0 1.0000000199999999 0.0754518357307923; 2.0 4.00000002 2.0014227581346167; 0.9622740913884575 0.9259714469574816 4.011103905995438e-8; 0.9350178459150931 0.8742583921797008 0.03556834774086653;;; 2.0 4.00000002 2.82842714474619; 1.0 1.00000002 4.504859041558669e-8; 2.0 4.00000002 2.0000000200000003; 0.9999999913157247 1.0000000026314497 4.025998994066464e-8; 2.0 4.00000002 2.0000000200000003; 1.0 1.00000002 4.5048590616114154e-8; 0.9629629572080052 0.9272976769547864 4.161103908025339e-8; 2.0 4.00000002 2.0000000200000003; 1.0 1.00000002 4.5048590457653996e-8; 2.0 4.00000002 2.82842714474619; 1.0 1.00000002 4.5048590457653996e-8; 2.0 4.00000002 2.0000000200000003; 0.9999999913157247 1.0000000026314497 4.0259989924885146e-8; 0.9629629572080052 0.9272976769547864 4.161103909512462e-8]
    sol = parabolic_solve(fem2d(;L=1); h=0.5, p=1.0)
    @test norm(cat(sol.u...; dims=3) - z) < 1e-6
    @test (plot(sol); true)
    z = [-1.0 0.0 0.0; -0.5 0.0 0.0; 0.5 0.0 0.0; 1.0 0.0 0.0;;; -1.0 1.0000000199999999 0.33333340133332057; -0.7499999865000032 0.5624999997500051 0.6666666956666663; 0.2500000045000005 0.06250002225000026 1.333333338333336; 1.0 1.0000000199999999 1.6666666866666593;;; -1.0 1.0000000199999999 7.843136722659069e-8; -0.9249999767233775 0.8556249769382487 0.33333338974560867; -0.024999971346599172 0.0006250185673306015 1.5999999871722435; 1.0 1.0000000199999999 2.533333269755225]
    sol = parabolic_solve(spectral1d(;n=4); h=0.5, p=1.0)
    @test norm(cat(sol.u...; dims=3) - z) < 1e-6
    @test (plot(sol); true)
    z = [2.0 0.0 0.0; 1.25 0.0 0.0; 1.25 0.0 0.0; 2.0 0.0 0.0; 1.25 0.0 0.0; 0.5 0.0 0.0; 0.5 0.0 0.0; 1.25 0.0 0.0; 1.25 0.0 0.0; 0.5 0.0 0.0; 0.5 0.0 0.0; 1.25 0.0 0.0; 2.0 0.0 0.0; 1.25 0.0 0.0; 1.25 0.0 0.0; 2.0 0.0 0.0;;; 2.0 4.00000002 2.8284271447461906; 1.25 1.5625000199999999 1.0032642224728898; 1.25 1.5625000199999999 1.0032642224728898; 2.0 4.00000002 2.8284271447461897; 1.25 1.5625000199999999 1.0032642224728898; 1.219675829650654 1.4876091494340113 0.057179823967679226; 1.219675829650654 1.4876091494340111 0.05717982396767934; 1.25 1.5625000199999999 1.0032642224728898; 1.25 1.5625000199999999 1.0032642224728898; 1.219675829650654 1.4876091494340111 0.057179823967679344; 1.219675829650654 1.487609149434011 0.05717982396767943; 1.25 1.5625000199999999 1.0032642224728898; 2.0 4.00000002 2.8284271447461897; 1.25 1.5625000199999999 1.0032642224728898; 1.25 1.5625000199999999 1.0032642224728898; 2.0 4.00000002 2.828427144746189;;; 2.0 4.000000019999243 2.828427144745434; 1.25 1.5625000199992432 1.0000000199992434; 1.25 1.5625000199992432 1.0000000199992434; 2.0 4.000000019999243 2.828427144745433; 1.25 1.5625000199992432 1.0000000199992434; 1.2499999930813022 1.562500002702499 4.387744233437229e-8; 1.249999993081302 1.5625000027024984 4.387744248642403e-8; 1.25 1.5625000199992432 1.0000000199992434; 1.25 1.5625000199992432 1.0000000199992434; 1.249999993081302 1.5625000027024984 4.387744248642407e-8; 1.2499999930813022 1.5625000027024982 4.387744263847581e-8; 1.25 1.5625000199992432 1.0000000199992434; 2.0 4.000000019999243 2.828427144745433; 1.25 1.5625000199992432 1.0000000199992434; 1.25 1.5625000199992432 1.0000000199992434; 2.0 4.000000019999243 2.828427144745432]
    sol = parabolic_solve(spectral2d(;n=4); h=0.5, p=1.0)
    @test norm(cat(sol.u...; dims=3) - z) < 1e-6
    @test (plot(sol); true)
    @test (MultiGridBarrier.amg_precompile(); true)
    @test (MultiGridBarrier.parabolic_precompile(); true)
end

@testset "Structured FEM (BlockMatrices)" begin
    # fem1d structured matches unstructured reference
    sol_ref = fem1d_solve(L=1, p=1.0, verbose=false)
    sol_str = fem1d_solve(L=1, p=1.0, verbose=false, structured=true)
    @test norm(sol_ref.z - sol_str.z) < 1e-10

    # fem2d structured matches unstructured reference
    sol_ref = fem2d_solve(L=1, p=1.0, verbose=false)
    sol_str = fem2d_solve(L=1, p=1.0, verbose=false, structured=true)
    @test norm(sol_ref.z - sol_str.z) < 1e-10

    # Roundtrip test: extract then convert back to sparse
    g = fem2d(L=1, structured=false)
    p_blk = 7
    for (key, op) in g.operators
        bd = MultiGridBarrier._extract_block_diag(op, p_blk)
        @test norm(MultiGridBarrier.to_sparse(bd) - op) < 1e-12
    end

    # Roundtrip for refine/coarsen
    for l in 1:length(g.refine)
        m, n = size(g.refine[l])
        if m == n
            K = 1
        else
            N_l = n รท p_blk
            K = m รท (p_blk * N_l)
        end
        vbd = MultiGridBarrier._extract_sub_block_diag(g.refine[l], p_blk, K, :V)
        @test norm(MultiGridBarrier.to_sparse(vbd) - g.refine[l]) < 1e-12
        hbd = MultiGridBarrier._extract_sub_block_diag(g.coarsen[l], p_blk, K, :H)
        @test norm(MultiGridBarrier.to_sparse(hbd) - g.coarsen[l]) < 1e-12
    end
end

# Include additional coverage tests
include("test_algebraic_coverage.jl")

# Include 3D Mesh tests
include("test_mesh3d.jl")

# Include CUDA extension tests (skipped if no GPU)
include("test_cuda.jl")
